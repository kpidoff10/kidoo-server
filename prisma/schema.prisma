generator client {
  provider = "prisma-client-js"
  output   = "../../kidoo-shared/prisma"
}

datasource db {
  provider = "postgresql"
}

model Character {
  id               String               @id @default(uuid())
  name             String?
  defaultImageUrl  String?
  sex              CharacterSex
  personality      CharacterPersonality
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  stylePrompt      String?
  imageHeight      Int                  @default(240)
  imageWidth       Int                  @default(280)
  characterContext String?
  clips            Clip[]
  emotionDevices   EmotionDevice[]
  rules            Rule[]

  @@map("characters")
}

model Emotion {
  id               String            @id @default(uuid())
  key              String            @unique
  label            String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  promptCustom     String?
  clips            Clip[]
  deviceClipCaches DeviceClipCache[]
  emotionVideos    EmotionVideo[]

  @@map("emotions")
}

model Clip {
  id                String            @id @default(uuid())
  characterId       String
  emotionId         String
  status            ClipStatus        @default(DRAFT)
  fileUrl           String?
  sha256            String?
  sizeBytes         Int?
  width             Int?
  height            Int?
  fps               Int?
  frames            Int?
  durationS         Float?
  prompt            String?
  modelName         String?
  previewUrl        String?
  weight            Int               @default(100)
  tags              String[]          @default([])
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  xaiJobId          String?
  loopStartFrame    Int?
  loopEndFrame      Int?
  workingPreviewUrl String?
  variantPrompt     String?
  trigger           String?           @default("manual")
  variant           Int               @default(1)
  artifacts         ClipArtifact[]
  faceRegions       ClipFaceRegion[]
  character         Character         @relation(fields: [characterId], references: [id], onDelete: Cascade)
  emotion           Emotion           @relation(fields: [emotionId], references: [id], onDelete: Cascade)
  deviceClipCaches  DeviceClipCache[]
  emotionVideos     EmotionVideo[]

  @@index([characterId])
  @@index([emotionId])
  @@index([characterId, emotionId])
  @@index([status])
  @@map("clips")
}

model ClipArtifact {
  id          String      @id @default(uuid())
  clipId      String
  frameIndex  Int         @default(0)
  name        String
  x           Float
  y           Float
  w           Float
  h           Float
  cornerStyle CornerStyle @default(ROUNDED)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  imageUrl    String?
  clip        Clip        @relation(fields: [clipId], references: [id], onDelete: Cascade)

  @@index([clipId])
  @@map("clip_artifacts")
}

model ClipFaceRegion {
  id          String        @id @default(uuid())
  clipId      String
  regionKey   FaceRegionKey
  x           Float
  y           Float
  w           Float
  h           Float
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  frameIndex  Int           @default(0)
  cornerStyle CornerStyle   @default(ROUNDED)
  imageUrl    String?
  clip        Clip          @relation(fields: [clipId], references: [id], onDelete: Cascade)

  @@unique([clipId, regionKey, frameIndex])
  @@index([clipId])
  @@map("clip_face_regions")
}

model EmotionVideo {
  id            String     @id @default(uuid())
  emotionId     String
  sourceClipId  String
  name          String?
  fps           Int        @default(10)
  width         Int        @default(240)
  height        Int        @default(280)
  status        ClipStatus @default(DRAFT)
  binUrl        String?
  sha256        String?
  sizeBytes     Int?
  durationS     Float?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  exitTimeline  Json
  introTimeline Json
  loopTimeline  Json
  totalFrames   Int?
  idxUrl        String?
  emotion       Emotion    @relation(fields: [emotionId], references: [id], onDelete: Cascade)
  sourceClip    Clip       @relation(fields: [sourceClipId], references: [id], onDelete: Cascade)

  @@unique([sourceClipId, emotionId])
  @@index([emotionId])
  @@index([sourceClipId])
  @@index([status])
  @@map("emotion_videos")
}

model EmotionDevice {
  id               String            @id @default(uuid())
  characterId      String
  pubnubChannel    String?
  mode             EmotionDeviceMode @default(NORMAL)
  isCharging       Boolean           @default(false)
  lastSeenAt       DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deviceClipCaches DeviceClipCache[]
  character        Character         @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@map("emotion_devices")
}

model DeviceClipCache {
  deviceId     String
  emotionId    String
  slot         Int
  clipId       String
  lastSeenAt   DateTime      @default(now())
  lastPlayedAt DateTime?
  clip         Clip          @relation(fields: [clipId], references: [id], onDelete: Cascade)
  device       EmotionDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  emotion      Emotion       @relation(fields: [emotionId], references: [id], onDelete: Cascade)

  @@id([deviceId, emotionId, slot])
  @@index([deviceId])
  @@index([emotionId])
  @@index([clipId])
  @@map("device_clip_caches")
}

model Rule {
  id          String     @id @default(uuid())
  characterId String?
  enabled     Boolean    @default(true)
  priority    Int        @default(0)
  cooldownMs  Int        @default(0)
  eventType   EventType
  eventKey    EventKey
  conditions  Json?
  response    Json
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  character   Character? @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([enabled, eventType, eventKey])
  @@map("rules")
}

model ObjectType {
  id          String       @id @default(uuid())
  key         String       @unique
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  rfidObjects RfidObject[]

  @@map("object_types")
}

model RfidObject {
  uid          String     @unique
  objectTypeId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  objectType   ObjectType @relation(fields: [objectTypeId], references: [id], onDelete: Cascade)

  @@index([objectTypeId])
  @@map("rfid_objects")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified DateTime?
  name          String?
  avatar        String?
  password      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  isAdmin       Boolean   @default(false)
  accounts      Account[]
  files         File[]
  kidoos        Kidoo[]
  sessions      Session[]
  tags          Tag[]

  @@map("users")
}

model Kidoo {
  id                  String            @id @default(uuid())
  name                String
  model               KidooModel        @default(basic)
  macAddress          String?
  deviceId            String            @unique
  firmwareVersion     String?
  lastConnected       DateTime?
  isConnected         Boolean           @default(false)
  wifiSSID            String?
  userId              String?
  isSynced            Boolean           @default(false)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  bluetoothMacAddress String?
  brightness          Int               @default(100)
  sleepColorB         Int?
  sleepColorG         Int?
  sleepColorR         Int?
  sleepEffect         Int?
  sleepTimeout        Int               @default(30000)
  configBasic         KidooConfigBasic?
  configDream         KidooConfigDream?
  user                User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags                Tag[]

  @@index([userId])
  @@index([deviceId])
  @@index([model])
  @@map("kidoos")
}

model Tag {
  id              String   @id @default(uuid())
  uid             String?
  name            String?
  kidooId         String
  userId          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tagId           String?  @unique
  type            TagType?
  multimediaFiles File[]
  kidoo           Kidoo    @relation(fields: [kidooId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([kidooId])
  @@index([userId])
  @@index([uid])
  @@index([tagId])
  @@index([type])
  @@map("tags")
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Firmware {
  id        String     @id @default(uuid())
  model     KidooModel
  version   String
  url       String
  path      String
  fileName  String
  fileSize  Int
  createdAt DateTime   @default(now())
  changelog String?
  partCount Int        @default(1)

  @@unique([model, version])
  @@index([model])
  @@map("firmwares")
}

model File {
  id           String   @id @default(uuid())
  tagId        String
  userId       String
  url          String
  path         String
  fileName     String
  originalName String
  size         Int
  mimeType     String
  order        Int      @default(0)
  disabled     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tag          Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tagId])
  @@index([userId])
  @@index([createdAt])
  @@index([tagId, order])
  @@map("files")
}

model KidooConfigBasic {
  id                 String    @id @default(uuid())
  kidooId            String    @unique
  storageTotalBytes  BigInt?
  storageFreeBytes   BigInt?
  storageUsedBytes   BigInt?
  storageFreePercent Int?
  storageUsedPercent Int?
  storageLastUpdated DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  kidoo              Kidoo     @relation(fields: [kidooId], references: [id], onDelete: Cascade)

  @@index([kidooId])
  @@map("kidoo_config_basic")
}

model KidooConfigDream {
  id               String                            @id @default(uuid())
  kidooId          String                            @unique
  colorR           Int?
  colorG           Int?
  colorB           Int?
  brightness       Int?
  allNight         Boolean                           @default(false)
  effect           String?
  wakeupColorR     Int?
  wakeupColorG     Int?
  wakeupColorB     Int?
  wakeupBrightness Int?
  createdAt        DateTime                          @default(now())
  updatedAt        DateTime                          @updatedAt
  kidoo            Kidoo                             @relation(fields: [kidooId], references: [id], onDelete: Cascade)
  bedtimeSchedules KidooConfigDreamBedtimeSchedule[]
  wakeupSchedules  KidooConfigDreamWakeupSchedule[]

  @@index([kidooId])
  @@map("kidoo_config_dream")
}

model KidooConfigDreamBedtimeSchedule {
  id                 String           @id @default(uuid())
  kidooConfigDreamId String
  weekday            String
  hour               Int
  minute             Int
  activated          Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  kidooConfigDream   KidooConfigDream @relation(fields: [kidooConfigDreamId], references: [id], onDelete: Cascade)

  @@unique([kidooConfigDreamId, weekday])
  @@index([kidooConfigDreamId])
  @@map("kidoo_config_dream_bedtime_schedule")
}

model KidooConfigDreamWakeupSchedule {
  id                 String           @id @default(uuid())
  kidooConfigDreamId String
  weekday            String
  hour               Int
  minute             Int
  activated          Boolean          @default(false)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  kidooConfigDream   KidooConfigDream @relation(fields: [kidooConfigDreamId], references: [id], onDelete: Cascade)

  @@unique([kidooConfigDreamId, weekday])
  @@index([kidooConfigDreamId])
  @@map("kidoo_config_dream_wakeup_schedule")
}

enum TagType {
  MUSIC
  STORY
  SOUND
}

enum CharacterSex {
  FEMALE
  MALE
}

enum CharacterPersonality {
  TIMID
  GRUMPY
  FUNNY
  ALWAYS_HUNGRY
  BASIC
}

enum EventType {
  RFID
  TEMP
  IMU
  TOUCH
  POWER
  SYSTEM
}

enum EventKey {
  TAG_PRESENT
  TAG_ABSENT
  TEMP_READING
  TEMP_HOT
  TEMP_COLD
  IMU_SHAKE
  IMU_TILT
  TOUCH_TAP
  TOUCH_LONG
  CHARGING_STARTED
  CHARGING_STOPPED
  SLEEP_ENTER
  SLEEP_EXIT
  CUSTOM
}

enum ClipStatus {
  DRAFT
  GENERATING
  READY
  FAILED
  DISABLED
}

enum FaceRegionKey {
  LEFT_EYE
  RIGHT_EYE
  MOUTH
}

enum CornerStyle {
  ROUNDED
  SQUARE
}

enum EmotionDeviceMode {
  NORMAL
  CHARGING
  SLEEP
}

enum KidooModel {
  basic
  dream
}
